stages:
  - build
  - mirror

variables:
  IMAGE_NAME: "airflow"
  IMAGE_TAG: "$HARBOR_REGISTRY/public/$IMAGE_NAME"
  GIT_DEPTH: 0

build-and-push:
  stage: build
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  script:
    - |
      echo "{\"auths\":{\"$HARBOR_REGISTRY\":{\"username\":\"$HARBOR_PUB_ROBOT_USER\",\"password\":\"$HARBOR_PUB_ROBOT_PASSWORD\"}}}" > /kaniko/.docker/config.json
      /kaniko/executor \
        --context "${CI_PROJECT_DIR}" \
        --dockerfile "${CI_PROJECT_DIR}/Dockerfile" \
        --build-arg "VERSION=${CI_COMMIT_SHORT_SHA}" \
        --destination "$IMAGE_TAG:latest" \
        --destination "$IMAGE_TAG:$CI_COMMIT_TAG"
  tags:
    - lema
    - default
  only:
    - tags

mirror_to_github:
  stage: mirror
  image: alpine:latest
  tags:
    - lema
    - default
  only:
    - main
  before_script:
    - apk add --no-cache git openssh
    # Configura o git
    - git config --global user.name "GitLab CI"
    - git config --global user.email "ci@gitlab"
    # Clona o reposit√≥rio
    - git clone --mirror "$CI_REPOSITORY_URL" repo
    - cd repo
    # Adiciona o remoto do GitHub (usando token pessoal ou deploy key)
    - git remote add github "https://${GITHUB_USERNAME}:${GITHUB_TOKEN}@github.com/${GITHUB_USERNAME}/airflow.git"
  script:
    - git push github --mirror