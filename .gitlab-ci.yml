# Pipeline stages
stages:
  - build
  - test

variables:
  IMAGE_NAME: "airflow"
  IMAGE_TAG: "$HARBOR_REGISTRY/public/$IMAGE_NAME"
  GIT_DEPTH: 0

build-and-push:
  stage: build
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  script:
    - |
      echo "{\"auths\":{\"$HARBOR_REGISTRY\":{\"username\":\"$HARBOR_PUB_ROBOT_USER\",\"password\":\"$HARBOR_PUB_ROBOT_PASSWORD\"}}}" > /kaniko/.docker/config.json
      /kaniko/executor \
        --context "${CI_PROJECT_DIR}" \
        --dockerfile "${CI_PROJECT_DIR}/Dockerfile" \
        --build-arg "VERSION=${CI_COMMIT_SHORT_SHA}" \
        --destination "$IMAGE_TAG:latest" \
        --destination "$IMAGE_TAG:$CI_COMMIT_TAG"
  tags:
    - lema
    - default
  only:
    - tags

test:
  stage: test
  image: alpine/git
  before_script: |
    apk add --no-cache openssh rsync
    mkdir -p ~/.ssh
    echo "${SSH_PRIVATE_KEY}" > ~/.ssh/id_rsa
    chmod 700 ~/.ssh
    chmod 600 ~/.ssh/id_rsa
  script: |
    echo "ðŸš€ Publish release "
    TAG=$(git describe --tags `git rev-list --tags --max-count=1`)
    echo "{ \"last_release\": \"$TAG\" }" > airflow.json
    rsync -avz \
      --no-perms --no-owner --no-group --no-times \
      -e "ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -i ~/.ssh/id_rsa" \
      "airflow.json" "$SSH_USERNAME@$NGINX_DATA_HOST:$NGINX_HTML_DIR/airflow.json"
  tags:
    - lema
    - default
  only:
    - main
