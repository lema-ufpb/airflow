# Pipeline stages
stages:
  - build
  - push
  - pages

variables:
  IMAGE_NAME: "airflow"
  DOCKER_HOST: tcp://docker:2376
  DOCKER_TLS_CERTDIR: "/certs"
  IMAGE_TAG: "$HARBOR_REGISTRY/public/$IMAGE_NAME"
  GIT_DEPTH: 0

image: docker:latest

services:
  - docker:dind

build:
  stage: build
  before_script:
    - echo $HARBOR_PUB_ROBOT_PASSWORD | docker login --username $HARBOR_PUB_ROBOT_USER --password-stdin $HARBOR_REGISTRY
  script:
    - echo "ðŸš€ Build version $CI_COMMIT_TAG"
    - mkdir -p ./tar_images
    - docker build --build-arg VERSION=$CI_COMMIT_TAG --tag $IMAGE_TAG:latest .
    - docker save $IMAGE_TAG:latest > ./tar_images/image_file.tar
  cache:
    paths:
      - tar_images/
    when: on_success
  tags:
    - lema
    - default
  only:
    - tags

push:
  stage: push
  before_script:
    - echo $HARBOR_PUB_ROBOT_PASSWORD | docker login --username $HARBOR_PUB_ROBOT_USER --password-stdin $HARBOR_REGISTRY
  script:
    - echo "ðŸš€ Push version $CI_COMMIT_TAG"
    - docker image load --input ./tar_images/image_file.tar
    - docker push $IMAGE_TAG:latest
    - docker image tag $IMAGE_TAG:latest $IMAGE_TAG:$CI_COMMIT_TAG
    - docker push $IMAGE_TAG:$CI_COMMIT_TAG
    - docker push $IMAGE_TAG:latest
  cache:
    paths:
      - tar_images/
  tags:
    - lema
    - default
  only:
    - tags

pages:
  stage: pages
  script: |
    echo "ðŸš€ Publish release page"
    TAG=$(git describe --tags `git rev-list --tags --max-count=1`)
    mkdir -p public
    echo "{ \"last_release\": \"$TAG\" }" > public/index.json
  artifacts:
    paths:
      - public
  tags:
    - lema
    - default
  only:
    - tags
