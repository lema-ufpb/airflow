# Pipeline stages
stages:
  - build
  - push
  - pages

variables:
  IMAGE_NAME: "airflow"
  IMAGE_TAG: "$HARBOR_REGISTRY/public/$IMAGE_NAME"
  GIT_DEPTH: 0

build:
  stage: build
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  script:
    - |
      mkdir -p ./tar_images
      /kaniko/executor \
        --context "${CI_PROJECT_DIR}" \
        --dockerfile "${CI_PROJECT_DIR}/Dockerfile" \
        --build-arg "VERSION=${CI_COMMIT_SHORT_SHA}" \
        --no-push \
        --destination "$IMAGE_TAG:latest" \
        --tarPath ./tar_images/image_file.tar
  artifacts:
    paths:
      - tar_images/
    expire_in: 1 hour
  tags:
    - lema
    - default
  only:
    - tags

push:
  stage: push
  image:
    name: gcr.io/go-containerregistry/crane:debug
    entrypoint: [""]
  script:
    - |
      cd ./tar_images
      crane auth login -u $HARBOR_PUB_ROBOT_USER -p $HARBOR_PUB_ROBOT_PASSWORD $HARBOR_REGISTRY;
      crane push image_file.tar $IMAGE_TAG:$CI_COMMIT_TAG;
      crane push image_file.tar $IMAGE_TAG:latest;
  cache:
    paths:
      - tar_images/
  tags:
    - lema
    - default
  only:
    - tags

pages:
  stage: pages
  script: |
    echo "ðŸš€ Publish release page"
    TAG=$(git describe --tags `git rev-list --tags --max-count=1`)
    mkdir -p public
    echo "{ \"last_release\": \"$TAG\" }" > public/index.json
  artifacts:
    paths:
      - public
  tags:
    - lema
    - default
  only:
    - tags
